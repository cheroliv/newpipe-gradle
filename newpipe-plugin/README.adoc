= newpipe-plugin
:toc: left
:toc-title: Contents
:toclevels: 3
:icons: font
:source-highlighter: highlight.js
:hardbreaks-option:

++++
<p align="right">
  <a href="README_fr.adoc">
    <img src="images/lang-fr-red.svg" alt="Français" width="64"/>
  </a>
</p>
++++

image:https://img.shields.io/badge/Kotlin-2.x-7F52FF?logo=kotlin[Kotlin]
image:https://img.shields.io/badge/Gradle-8.x-02303A?logo=gradle[Gradle]
image:https://img.shields.io/badge/JitPack-published-brightgreen[JitPack]
image:https://img.shields.io/badge/License-Apache%202.0-blue.svg[License]

A Gradle plugin (`com.cheroliv.newpipe`) that downloads music from YouTube
and converts it to MP3 — no Python dependency, pure JVM.

== Value Proposition

In a JVM ecosystem, integrating `yt-dlp` requires Python, `pip`, and Python
version management across machines and CI agents. This plugin eliminates that
friction: a single Gradle dependency, zero mandatory system tools beyond
FFmpeg (or Docker).

== Architecture

=== Overview

[source,text]
----
newpipe-plugin/
└── newpipe/
    └── src/
        ├── main/kotlin/com/cheroliv/newpipe/
        │   ├── DownloaderPlugin.kt      Plugin entry point
        │   ├── NewpipeExtension.kt      DSL extension (configPath, ffmpegDockerImage, forceDocker)
        │   ├── NewpipeManager.kt        Task registration + YAML parsing
        │   ├── Models.kt                Selection / Artist data classes
        │   ├── DownloadMusicTask.kt     Main Gradle task
        │   ├── VideoServices.kt         VideoInfoProvider / AudioConverter interfaces
        │   ├── VideoMetadata.kt         Data class decoupled from StreamInfo
        │   ├── YouTubeDownloader.kt     Real implementation (NewPipe + OkHttp)
        │   ├── Mp3Converter.kt          Real implementation (FFmpeg / Docker + jaudiotagger)
        │   └── DownloaderImpl.kt        NewPipe Downloader (OkHttp singleton)
        └── test/kotlin/com/cheroliv/newpipe/
            ├── FakeVideoInfoProvider.kt Network-free fake for tests
            ├── FakeAudioConverter.kt    FFmpeg-free fake for tests
            └── scenarios/              Cucumber tests (GradleTestKit)
----

=== Execution Flow

[source,text]
----
musics.yml
    │
    ▼
NewpipeManager.registerDownloadTask()
    │  parse YAML → Selection → tuneEntries + playlistUrls
    ▼
DownloadMusicTask.download()
    │
    ├── Playlist resolution (sequential)
    │     └── VideoInfoProvider.getPlaylistVideoUrls()
    │           ├── Mix Radio (list=RD...) → first page only (~15 tracks)
    │           └── Standard playlist     → all pages (cap at 50)
    │
    └── Concurrent pipeline (Semaphore 3) for each URL
          │
          ├── fetchAudio()
          │     ├── VideoInfoProvider.getVideoInfo()      → VideoMetadata
          │     ├── AudioConverter.alreadyDownloaded()    → skip if duplicate
          │     └── VideoInfoProvider.downloadBestAudio() → _temp.m4a
          │
          └── convertTrack() — immediately after download completes
                ├── AudioConverter.convertToMp3()         → FFmpeg 192k
                └── AudioConverter.addMetadata()          → ID3 tags + cover
----

== Core Components

=== VideoInfoProvider / AudioConverter

Two interfaces allow real implementations to be swapped for fakes in tests
without crossing the GradleTestKit JVM boundary.

[source,kotlin]
----
interface VideoInfoProvider {
    suspend fun getVideoInfo(url: String): VideoMetadata
    suspend fun getPlaylistVideoUrls(playlistUrl: String): List<String>
    suspend fun downloadBestAudio(
        metadata: VideoMetadata,
        outputFile: File,
        onProgress: (downloaded: Long, total: Long, percent: Int) -> Unit
    ): File
    fun sanitizeFileName(name: String): String
}

interface AudioConverter {
    fun alreadyDownloaded(mp3File: File, title: String, artist: String,
                          youtubeDurationSeconds: Long, toleranceSeconds: Long = 2L): Boolean
    suspend fun convertToMp3(inputFile: File, outputFile: File, bitrate: String = "192k"): File
    suspend fun addMetadata(mp3File: File, title: String?, artist: String?,
                            album: String?, thumbnailUrl: String?): File
}
----

=== VideoMetadata

A clean data class that decouples the plugin from NewPipe Extractor's
`StreamInfo` (a `final` class that cannot be instantiated from outside the
library).

[source,kotlin]
----
data class VideoMetadata(
    val title: String,
    val uploaderName: String,
    val duration: Long,
    val url: String,
    val streamInfo: StreamInfo? = null  // null in test mode
)
----

=== NewpipeExtension — DSL

The DSL extension exposes three properties to the consumer's `build.gradle.kts`:

[source,kotlin]
----
open class NewpipeExtension @Inject constructor(objects: ObjectFactory) {

    // Required — absolute path to musics.yml
    val configPath: Property<String> = objects.property(String::class.java)

    // Optional — Docker image for FFmpeg conversion. Default: "jrottenberg/ffmpeg:4.4-alpine"
    val ffmpegDockerImage: Property<String> = objects
        .property(String::class.java)
        .convention(DEFAULT_FFMPEG_IMAGE)

    // Optional — force Docker even if FFmpeg is installed locally. Default: false
    val forceDocker: Property<Boolean> = objects
        .property(Boolean::class.java)
        .convention(false)
}
----

[cols="1,2,1,2", options="header"]
|===
| Property | Type | Default | Description

| `configPath`
| `String`
| —
| *Required.* Absolute path to the `musics.yml` selection file.

| `ffmpegDockerImage`
| `String`
| `jrottenberg/ffmpeg:4.4-alpine`
| Docker image used for conversion when FFmpeg is not installed locally,
or when `forceDocker = true`.

| `forceDocker`
| `Boolean`
| `false`
| When `true`, skips the local FFmpeg probe and always uses Docker,
even if `ffmpeg` is available on the system `PATH`.
|===

=== Mp3Converter — FFmpeg Strategy

The conversion strategy is resolved *once at construction*, in priority order:

[cols="1,1,3", options="header"]
|===
| Priority | Strategy | Condition

| 1
| `LOCAL`
| `ffmpeg -version` exits 0 *and* `forceDocker = false`

| 2
| `DOCKER`
| `docker info` exits 0 (daemon running)

| 3
| `NONE`
| Neither available → `ConversionException` at conversion time
|===

When the `DOCKER` strategy is active, the plugin runs:

[source,bash]
----
docker run --rm \
  --user <current-uid>:<current-gid> \
  -v <artist-dir>:/data \
  <ffmpegDockerImage> \
  -i /data/<input.m4a> -vn -ar 44100 -ac 2 -b:a 192k -y \
  /data/<output.mp3>
----

The `--user` flag ensures the MP3 is owned by the user running Gradle (not the
container's root), preventing permission errors when jaudiotagger writes the
ID3 tags. Both the temp file and the output MP3 share the same artist directory,
so a single volume mount covers both.

=== DownloadMusicTask — Concurrency

Downloads are concurrent (up to 3 at a time via `Semaphore`). FFmpeg
conversion starts immediately after each download in the same coroutine —
`_temp.m4a` files do not accumulate.

[source,kotlin]
----
val semaphore = Semaphore(MAX_CONCURRENT_DOWNLOADS) // = 3

allEntries.map { (artistHint, tuneUrl) ->
    async(Dispatchers.IO) {
        semaphore.withPermit {
            val track = fetchAudio(tuneUrl, artistHint, baseOutputDir, label)
            convertTrack(converter, track)  // immediate conversion
        }
    }
}.awaitAll()
----

=== DownloaderImpl — OkHttp Singleton

A single `OkHttpClient` is shared between metadata extraction (NewPipe
Extractor) and audio download — avoiding redundant TCP/TLS handshakes and
thread pool multiplication.

[source,kotlin]
----
companion object {
    val httpClient: OkHttpClient = OkHttpClient.Builder()
        .connectTimeout(30, TimeUnit.SECONDS)
        .readTimeout(60, TimeUnit.SECONDS)
        .writeTimeout(30, TimeUnit.SECONDS)
        .build()
}
----

The download buffer is 128 KB to minimise kernel syscall overhead.

== Testing Strategy

=== The Problem

GradleTestKit runs the plugin in a separate JVM — Mockito cannot cross that
boundary. Real YouTube downloads + FFmpeg make Cucumber tests slow (2+ minutes
per scenario).

=== Solution — System Property + Fakes

[source,kotlin]
----
// DownloadMusicTask.kt
companion object {
    const val MOCK_PROPERTY = "newpipe.test.mock"
}

private fun newInfoProvider(): VideoInfoProvider =
    if (System.getProperty(MOCK_PROPERTY) == "true") FakeVideoInfoProvider()
    else YouTubeDownloader()
----

[source,kotlin]
----
// TestWorld.kt — flag is passed automatically to GradleRunner
.withArguments(tasks + "--stacktrace" + "-D${DownloadMusicTask.MOCK_PROPERTY}=true")
----

Fakes return fixed data instantly — no network calls, no FFmpeg. Tests verify
folder structure, file naming, duplicate skipping and error handling in under
a second per scenario.

=== Running Tests

[source,bash]
----
# Cucumber tests only
./gradlew cucumberTest

# All tests
./gradlew check
----

== Dependencies

[cols="2,1,2", options="header"]
|===
| Dependency | Version | Role

| `com.github.TeamNewPipe:NewPipeExtractor`
| `dev` branch
| YouTube extraction (metadata + audio streams)

| `com.squareup.okhttp3:okhttp`
| 4.x
| HTTP client (shared between extraction and download)

| `org.jaudiotagger:jaudiotagger`
| 2.x
| ID3 tag and cover art writing

| `com.fasterxml.jackson.dataformat:jackson-dataformat-yaml`
| 2.x
| `musics.yml` parsing

| `org.jetbrains.kotlinx:kotlinx-coroutines-core`
| 1.x
| Concurrency (async/await, Semaphore, Dispatchers.IO)
|===

[NOTE]
====
NewPipe Extractor is resolved via https://jitpack.io[JitPack]. The version
points to the `dev` branch to benefit from the latest YouTube anti-throttling
fixes.
====

== Build & Publishing

=== Local Build

[source,bash]
----
cd newpipe-plugin
./gradlew build
----

=== Publish Locally (for consumer testing)

[source,bash]
----
./gradlew publishToMavenLocal
----

=== Publish to Maven Central

Publishing requires Sonatype credentials and a GPG key configured in
`~/.gradle/gradle.properties`:

[source,properties]
----
ossrhUsername=<your-username>
ossrhPassword=<your-password>
----

[source,bash]
----
./gradlew publish
----

== Known Issues

=== YouTube Throttling

YouTube throttles unofficial clients via the `n` parameter in the stream URL.
If downloads are abnormally slow on a fast connection, bumping the dependency
to the latest `dev` commit of NewPipe Extractor is the first step.

=== Mix Radio (list=RD...)

YouTube Mix Radio playlists are dynamically generated and cannot be paginated
beyond the first page. Full enumeration is not possible without the official
YouTube API.

== Roadmap

* [x] FFmpeg via Docker support (zero system dependency)
* [x] Configure the Docker image via the DSL (`ffmpegDockerImage`)
* [x] Force Docker even when FFmpeg is installed locally (`forceDocker`)
* [ ] Integration tests tagged `@integration` (real downloads, nightly CI)
* [ ] Download report at end of task (JSON/HTML summary)